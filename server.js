const express = require('express');
const twilio = require('twilio');
const dotenv = require('dotenv');
const cors = require('cors');
const axios = require('axios');

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Verifica√ß√£o das vari√°veis de ambiente
console.log('=== CONFIGURA√á√ïES ===');
console.log('TWILIO_ACCOUNT_SID:', process.env.TWILIO_ACCOUNT_SID);
console.log('TWILIO_AUTH_TOKEN:', process.env.TWILIO_AUTH_TOKEN ? 'Configurado' : 'N√£o configurado');
console.log('TWILIO_WHATSAPP_NUMBER:', process.env.TWILIO_WHATSAPP_NUMBER);
console.log('TELEGRAM_BOT_TOKEN:', process.env.TELEGRAM_BOT_TOKEN ? 'Configurado' : 'N√£o configurado');
console.log('TELEGRAM_CHAT_ID:', process.env.TELEGRAM_CHAT_ID);
console.log('====================');

const accountSid = process.env.TWILIO_ACCOUNT_SID;
const authToken = process.env.TWILIO_AUTH_TOKEN;
const client = twilio(accountSid, authToken);

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

// Configura√ß√£o dos m√©dicos e seus contatos
const doctors = {
    'dr_jose': {
        name: 'Dr. Jos√©',
        whatsapp: '+5581987654321',
        telegram: '1648736550'
    },
    'dr_alberto': {
        name: 'Dr. Alberto Silva',
        whatsapp: '+5581986509040',
        telegram: '1648736550'
    },
    'dr_novo': {
        name: 'Dr. Novo M√©dico',
        whatsapp: '+5581987740434',
        telegram: 'PENDING' // Ser√° atualizado ap√≥s descobrir o Chat ID
    },
    'dra_maria': {
        name: 'Dra. Maria Santos',
        whatsapp: '+5581999888777',
        telegram: '987654321'
    },
    'dr_ana': {
        name: 'Dra. Ana Costa',
        whatsapp: '+5581555444333',
        telegram: '123456789'
    }
};

// Fun√ß√£o para enviar mensagem para o Telegram
async function sendTelegramMessage(message, chatId = null) {
    const targetChatId = chatId || TELEGRAM_CHAT_ID;
    
    if (!TELEGRAM_BOT_TOKEN || !targetChatId) {
        throw new Error('TELEGRAM_BOT_TOKEN ou TELEGRAM_CHAT_ID n√£o configurados');
    }

    const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    
    try {
        const response = await axios.post(telegramUrl, {
            chat_id: targetChatId,
            text: message,
            parse_mode: 'HTML'
        });
        
        console.log('‚úÖ Mensagem enviada para o Telegram:', response.data.message_id);
        return response.data;
    } catch (error) {
        console.error('‚ùå Erro ao enviar para o Telegram:', error.response ? error.response.data : error.message);
        throw error;
    }
}

// Fun√ß√£o para enviar mensagem para o WhatsApp
async function sendWhatsAppMessage(message, phoneNumber = null) {
    const targetPhone = phoneNumber || '+5581986509040';
    
    try {
        const whatsappMessage = await client.messages.create({
            from: `whatsapp:${process.env.TWILIO_WHATSAPP_NUMBER}`,
            to: `whatsapp:${targetPhone}`,
            body: message
        });
        
        console.log('‚úÖ Mensagem WhatsApp enviada:', whatsappMessage.sid);
        return whatsappMessage;
    } catch (error) {
        console.error('‚ùå Erro ao enviar WhatsApp:', error.message);
        throw error;
    }
}

// Fun√ß√£o para enviar notifica√ß√£o personalizada por m√©dico
async function sendDoctorNotification(doctorKey, severity, patientName, cpf, phone, score) {
    const doctor = doctors[doctorKey];
    if (!doctor) {
        throw new Error(`M√©dico n√£o encontrado: ${doctorKey}`);
    }

    const results = { whatsapp: null, telegram: null, errors: [] };

    // Mensagem personalizada para WhatsApp
    const whatsappMessage = `üè• ALERTA M√âDICO - ${doctor.name}
    
üö® Severidade: ${severity}
üë§ Paciente: ${patientName || 'N√£o informado'}
üìÑ CPF: ${cpf || 'N√£o informado'}
üìû Contato: ${phone || 'N√£o informado'}
üìä Score de Risco: ${score}
‚è∞ Data/Hora: ${new Date().toLocaleString('pt-BR')}

‚ö†Ô∏è A√ß√£o necess√°ria conforme protocolo hospitalar.`;

    // Mensagem personalizada para Telegram
    const telegramMessage = `üè• <b>ALERTA M√âDICO</b> - ${doctor.name}

üö® <b>Severidade:</b> ${severity}
üë§ <b>Paciente:</b> ${patientName || 'N√£o informado'}
üìÑ <b>CPF:</b> ${cpf || 'N√£o informado'}
üìû <b>Contato:</b> ${phone || 'N√£o informado'}
üìä <b>Score de Risco:</b> ${score}
‚è∞ <b>Data/Hora:</b> ${new Date().toLocaleString('pt-BR')}

‚ö†Ô∏è <i>A√ß√£o necess√°ria conforme protocolo hospitalar.</i>`;

    // Enviar WhatsApp
    if (doctor.whatsapp && accountSid && authToken) {
        try {
            const whatsappResult = await sendWhatsAppMessage(whatsappMessage, doctor.whatsapp);
            results.whatsapp = {
                sid: whatsappResult.sid,
                to: doctor.whatsapp,
                doctor: doctor.name,
                status: 'Enviado'
            };
            console.log(`‚úÖ WhatsApp enviado para ${doctor.name} (${doctor.whatsapp}):`, whatsappResult.sid);
        } catch (error) {
            results.errors.push(`WhatsApp para ${doctor.name}: ${error.message}`);
            console.error(`‚ùå Erro WhatsApp ${doctor.name}:`, error.message);
        }
    }

    // Enviar Telegram
    if (doctor.telegram && doctor.telegram !== 'PENDING' && TELEGRAM_BOT_TOKEN) {
        try {
            const response = await sendTelegramMessage(telegramMessage, doctor.telegram);
            results.telegram = {
                messageId: response.message_id,
                chatId: doctor.telegram,
                doctor: doctor.name,
                status: 'Enviado'
            };
            console.log(`‚úÖ Telegram enviado para ${doctor.name} (${doctor.telegram}):`, response.message_id);
        } catch (error) {
            results.errors.push(`Telegram para ${doctor.name}: ${error.message}`);
            console.error(`‚ùå Erro Telegram ${doctor.name}:`, error.message);
        }
    }

    return results;
}

// Rota principal
app.get('/', (req, res) => {
    res.json({
        message: 'üè• Servidor MedChat funcionando!',
        timestamp: new Date().toISOString(),
        routes: {
            status: 'GET /status - Verificar configura√ß√µes',
            sendWhatsApp: 'POST /send-whatsapp - Enviar alerta completo', 
            testTelegram: 'POST /test-telegram - Testar apenas Telegram',
            notifyDoctor: 'POST /notify-doctor - Notificar m√©dico espec√≠fico',
            notifyMultiple: 'POST /notify-multiple-doctors - Notificar m√∫ltiplos m√©dicos',
            doctors: 'GET /doctors - Listar m√©dicos dispon√≠veis',
            telegramUsers: 'GET /telegram/users - Ver usu√°rios do bot',
            setupDoctor: 'POST /setup-new-doctor - Configurar novo m√©dico'
        }
    });
});

// Rota para verificar configura√ß√µes
app.get('/status', (req, res) => {
    res.json({
        timestamp: new Date().toISOString(),
        telegram: {
            botToken: TELEGRAM_BOT_TOKEN ? '‚úÖ Configurado' : '‚ùå N√£o configurado',
            chatId: TELEGRAM_CHAT_ID ? '‚úÖ Configurado' : '‚ùå N√£o configurado'
        },
        whatsapp: {
            accountSid: accountSid ? '‚úÖ Configurado' : '‚ùå N√£o configurado',
            authToken: authToken ? '‚úÖ Configurado' : '‚ùå N√£o configurado',
            phoneNumber: process.env.TWILIO_WHATSAPP_NUMBER ? '‚úÖ Configurado' : '‚ùå N√£o configurado'
        },
        doctors: {
            total: Object.keys(doctors).length,
            configured: Object.values(doctors).filter(d => d.telegram !== 'PENDING').length,
            pending: Object.values(doctors).filter(d => d.telegram === 'PENDING').length
        }
    });
});

// Rota para testar apenas o Telegram
app.post('/test-telegram', async (req, res) => {
    const testMessage = `üß™ <b>Teste do Telegram</b>
‚è∞ <b>Data:</b> ${new Date().toLocaleString('pt-BR')}
‚úÖ <b>Status:</b> Sistema funcionando corretamente!
üè• <b>Servidor:</b> MedChat
üë§ <b>Usu√°rio:</b> Pastor Alberto Silva`;

    if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
        return res.status(500).json({
            success: false,
            error: 'TELEGRAM_BOT_TOKEN ou TELEGRAM_CHAT_ID n√£o configurados',
            config: {
                botToken: TELEGRAM_BOT_TOKEN ? 'Configurado' : 'N√£o configurado',
                chatId: TELEGRAM_CHAT_ID ? 'Configurado' : 'N√£o configurado'
            }
        });
    }

    try {
        console.log('üöÄ Enviando mensagem de teste para o Telegram...');
        const result = await sendTelegramMessage(testMessage);
        
        res.status(200).json({
            success: true,
            message: 'Mensagem de teste enviada para o Telegram com sucesso!',
            telegram: {
                messageId: result.message_id,
                chatId: result.chat.id
            }
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message,
            details: error.response ? error.response.data : null
        });
    }
});

// Rota principal para enviar alertas (compatibilidade)
app.post('/send-whatsapp', async (req, res) => {
    console.log('üì• Recebido:', req.body);
    const { severity, patientName, cpf, phone, score, whatsappNumber, telegramChatId } = req.body;

    // Valida√ß√£o b√°sica
    if (!severity || !score) {
        return res.status(400).json({
            success: false,
            error: 'Campos obrigat√≥rios: severity e score'
        });
    }

    // Formata√ß√£o da mensagem para WhatsApp
    const whatsappMessage = `üö® Alerta: ${severity}
üë§ Paciente: ${patientName || 'N√£o informado'}
üìÑ CPF: ${cpf || 'N√£o informado'}
üìû Contato: ${phone || 'N√£o informado'}
üìä Score: ${score}
‚è∞ Data: ${new Date().toLocaleString('pt-BR')}`;

    // Formata√ß√£o da mensagem para Telegram (usando HTML)
    const telegramMessage = `üö® <b>Alerta:</b> ${severity}
üë§ <b>Paciente:</b> ${patientName || 'N√£o informado'}
üìÑ <b>CPF:</b> ${cpf || 'N√£o informado'}
üìû <b>Contato:</b> ${phone || 'N√£o informado'}
üìä <b>Score:</b> ${score}
‚è∞ <b>Data:</b> ${new Date().toLocaleString('pt-BR')}`;

    const results = {
        whatsapp: null,
        telegram: null,
        errors: []
    };

    // Enviar para WhatsApp
    if (accountSid && authToken && process.env.TWILIO_WHATSAPP_NUMBER) {
        try {
            console.log('üì± Enviando mensagem pelo WhatsApp...');
            const targetWhatsApp = whatsappNumber || '+5581986509040';
            results.whatsapp = await sendWhatsAppMessage(whatsappMessage, targetWhatsApp);
        } catch (error) {
            console.error('‚ùå Erro WhatsApp:', error.message);
            results.errors.push(`WhatsApp: ${error.message}`);
        }
    } else {
        results.errors.push('WhatsApp: Configura√ß√£o incompleta');
    }

    // Enviar para Telegram
    if (TELEGRAM_BOT_TOKEN) {
        try {
            console.log('üì± Enviando mensagem para o Telegram...');
            const targetTelegramChatId = telegramChatId || TELEGRAM_CHAT_ID;
            results.telegram = await sendTelegramMessage(telegramMessage, targetTelegramChatId);
        } catch (error) {
            console.error('‚ùå Erro Telegram:', error.message);
            results.errors.push(`Telegram: ${error.message}`);
        }
    } else {
        results.errors.push('Telegram: Configura√ß√£o incompleta');
    }

    // Resposta da API
    const hasSuccess = results.whatsapp || results.telegram;
    
    if (hasSuccess) {
        res.status(200).json({
            success: true,
            message: 'Alerta enviado com sucesso!',
            results: {
                whatsapp: results.whatsapp ? { 
                    sid: results.whatsapp.sid,
                    status: 'Enviado'
                } : null,
                telegram: results.telegram ? { 
                    messageId: results.telegram.message_id,
                    status: 'Enviado'
                } : null
            },
            errors: results.errors.length > 0 ? results.errors : null
        });
    } else {
        res.status(500).json({
            success: false,
            error: 'Falha ao enviar para ambos os canais',
            errors: results.errors
        });
    }
});

// Rota para notificar m√©dico espec√≠fico
app.post('/notify-doctor', async (req, res) => {
    console.log('üì• Notifica√ß√£o m√©dica recebida:', req.body);
    const { doctorKey, severity, patientName, cpf, phone, score } = req.body;

    // Valida√ß√£o
    if (!doctorKey) {
        return res.status(400).json({
            success: false,
            error: 'Campo obrigat√≥rio: doctorKey',
            availableDoctors: Object.keys(doctors)
        });
    }

    if (!doctors[doctorKey]) {
        return res.status(400).json({
            success: false,
            error: `M√©dico n√£o encontrado: ${doctorKey}`,
            availableDoctors: Object.keys(doctors)
        });
    }

    try {
        const results = await sendDoctorNotification(doctorKey, severity, patientName, cpf, phone, score);
        const doctor = doctors[doctorKey];
        
        // Mensagens de confirma√ß√£o personalizadas
        const confirmationMessages = [];
        
        if (results.whatsapp) {
            confirmationMessages.push(`üì± **Notifica√ß√£o enviada ao ${doctor.name} via WhatsApp com sucesso!**`);
        }
        
        if (results.telegram) {
            confirmationMessages.push(`üì± **Notifica√ß√£o enviada ao ${doctor.name} via Telegram com sucesso!**`);
        }

        const hasSuccess = results.whatsapp || results.telegram;
        
        if (hasSuccess) {
            res.status(200).json({
                success: true,
                message: `Notifica√ß√£o enviada para ${doctor.name}!`,
                confirmations: confirmationMessages,
                doctor: {
                    key: doctorKey,
                    name: doctor.name,
                    contacts: {
                        whatsapp: doctor.whatsapp,
                        telegram: doctor.telegram
                    }
                },
                results: results,
                errors: results.errors.length > 0 ? results.errors : null
            });
        } else {
            res.status(500).json({
                success: false,
                error: `Falha ao notificar ${doctor.name}`,
                errors: results.errors
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao notificar m√©dico:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Rota para notificar m√∫ltiplos m√©dicos
app.post('/notify-multiple-doctors', async (req, res) => {
    console.log('üì• Notifica√ß√£o m√∫ltipla recebida:', req.body);
    const { doctorKeys, severity, patientName, cpf, phone, score } = req.body;

    if (!doctorKeys || !Array.isArray(doctorKeys)) {
        return res.status(400).json({
            success: false,
            error: 'Campo obrigat√≥rio: doctorKeys (array)',
            availableDoctors: Object.keys(doctors)
        });
    }

    const allResults = [];
    const confirmationMessages = [];
    const errors = [];

    for (const doctorKey of doctorKeys) {
        if (!doctors[doctorKey]) {
            errors.push(`M√©dico n√£o encontrado: ${doctorKey}`);
            continue;
        }

        try {
            const results = await sendDoctorNotification(doctorKey, severity, patientName, cpf, phone, score);
            const doctor = doctors[doctorKey];
            
            allResults.push({
                doctor: doctor.name,
                key: doctorKey,
                results: results
            });

            if (results.whatsapp) {
                confirmationMessages.push(`üì± **Notifica√ß√£o enviada ao ${doctor.name} via WhatsApp com sucesso!**`);
            }
            
            if (results.telegram) {
                confirmationMessages.push(`üì± **Notifica√ß√£o enviada ao ${doctor.name} via Telegram com sucesso!**`);
            }

            if (results.errors.length > 0) {
                errors.push(...results.errors);
            }
        } catch (error) {
            errors.push(`Erro ao notificar ${doctorKey}: ${error.message}`);
        }
    }

    res.status(200).json({
        success: true,
        message: `Processo de notifica√ß√£o conclu√≠do para ${doctorKeys.length} m√©dico(s)`,
        confirmations: confirmationMessages,
        results: allResults,
        summary: {
            doctorsNotified: allResults.length,
            totalConfirmations: confirmationMessages.length,
            totalErrors: errors.length
        },
        errors: errors.length > 0 ? errors : null
    });
});

// Rota para listar m√©dicos dispon√≠veis
app.get('/doctors', (req, res) => {
    const doctorsList = Object.keys(doctors).map(key => ({
        key: key,
        name: doctors[key].name,
        whatsapp: doctors[key].whatsapp,
        telegram: doctors[key].telegram,
        status: doctors[key].telegram === 'PENDING' ? 'Aguardando configura√ß√£o' : 'Ativo'
    }));

    res.json({
        message: 'M√©dicos dispon√≠veis para notifica√ß√£o',
        count: doctorsList.length,
        doctors: doctorsList
    });
});

// Rota para listar usu√°rios que interagiram com o bot
app.get('/telegram/users', async (req, res) => {
    try {
        const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates`;
        const response = await axios.get(telegramUrl);
        
        const users = new Map();
        
        if (response.data.result) {
            response.data.result.forEach(update => {
                if (update.message && update.message.from) {
                    const user = update.message.from;
                    
                    users.set(user.id, {
                        chatId: user.id,
                        firstName: user.first_name,
                        lastName: user.last_name || '',
                        username: user.username || '',
                        lastMessage: update.message.text || '',
                        date: new Date(update.message.date * 1000).toLocaleString('pt-BR')
                    });
                }
            });
        }
        
        const userList = Array.from(users.values());
        
        res.json({
            message: 'Usu√°rios que interagiram com o bot',
            count: userList.length,
            users: userList,
            instructions: {
                step1: 'üì± Pessoa deve procurar @lbertoBot no Telegram',
                step2: '‚úÖ Clicar em Start e enviar mensagem',
                step3: 'üîç Use esta rota para ver o Chat ID',
                step4: '‚öôÔ∏è Configure o Chat ID no c√≥digo dos m√©dicos'
            }
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Rota para testar Chat ID espec√≠fico
app.post('/telegram/test-chat', async (req, res) => {
    const { chatId, doctorName } = req.body;
    
    if (!chatId) {
        return res.status(400).json({
            success: false,
            error: 'Chat ID √© obrigat√≥rio'
        });
    }
    
    const testMessage = `üß™ <b>Teste de Conex√£o - MedChat</b>

üëã Ol√°, ${doctorName || 'Doutor(a)'}!

‚úÖ <b>Chat ID:</b> <code>${chatId}</code>
‚è∞ <b>Data:</b> ${new Date().toLocaleString('pt-BR')}
ü§ñ <b>Bot:</b> @lbertoBot

üè• Se voc√™ recebeu esta mensagem, sua configura√ß√£o est√° funcionando perfeitamente!

üîî <i>Agora voc√™ receber√° alertas m√©dicos importantes.</i>`;

    try {
        const response = await sendTelegramMessage(testMessage, chatId);
        
        res.json({
            success: true,
            message: `‚úÖ Mensagem de teste enviada com sucesso!`,
            chatId: chatId,
            messageId: response.message_id,
            confirmation: `üì± **Notifica√ß√£o enviada via Telegram com sucesso!**`
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message,
            details: 'Verifique se o Chat ID est√° correto e se o usu√°rio iniciou o bot (@lbertoBot)'
        });
    }
});

// Rota espec√≠fica para configurar o novo m√©dico (+5581987740434)
app.post('/setup-new-doctor', async (req, res) => {
    const { chatId } = req.body;
    
    if (!chatId) {
        return res.status(400).json({
            success: false,
            error: 'Chat ID √© obrigat√≥rio',
            instructions: [
                '1. Pessoa deve procurar @lbertoBot no Telegram',
                '2. Clicar em Start e enviar mensagem',
                '3. Usar GET /telegram/users para ver o Chat ID',
                '4. Usar este endpoint com o Chat ID encontrado'
            ]
        });
    }
    
    // Atualizar o m√©dico no objeto (em produ√ß√£o, salvar em banco de dados)
    doctors['dr_novo'].telegram = chatId;
    
    const welcomeMessage = `üè• <b>Bem-vindo ao Sistema MedChat!</b>

üëã Ol√°! Seu WhatsApp <b>+5581987740434</b> foi configurado com sucesso!

‚úÖ <b>Chat ID:</b> <code>${chatId}</code>
üì± <b>WhatsApp:</b> +5581987740434
ü§ñ <b>Bot:</b> @lbertoBot

üîî <b>Voc√™ receber√° notifica√ß√µes sobre:</b>
‚Ä¢ üö® Alertas de pacientes por severidade
‚Ä¢ üè• Emerg√™ncias m√©dicas
‚Ä¢ üìä Atualiza√ß√µes do sistema

‚ö†Ô∏è <i>Mantenha as notifica√ß√µes ativadas para n√£o perder alertas importantes.</i>

üè• <b>Sistema MedChat - Sempre conectado √† sa√∫de!</b>`;

    try {
        const response = await sendTelegramMessage(welcomeMessage, chatId);
        
        res.json({
            success: true,
            message: 'üéâ Novo m√©dico configurado com sucesso!',
            doctor: {
                name: 'Dr. Novo M√©dico',
                whatsapp: '+5581987740434',
                telegram: chatId,
                status: 'Ativo'
            },
            confirmation: 'üì± **Notifica√ß√£o enviada ao +5581987740434 via Telegram com sucesso!**',
            messageId: response.message_id,
            nextSteps: [
                'M√©dico j√° pode receber notifica√ß√µes',
                'Use doctorKey: "dr_novo" para enviar alertas',
                'Teste com POST /notify-doctor'
            ]
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Rota para testar notifica√ß√£o do novo m√©dico
app.post('/test-new-doctor', async (req, res) => {
    const { severity = 'Teste', patientName = 'Paciente Teste', score = 85 } = req.body;
    
    if (doctors['dr_novo'].telegram === 'PENDING') {
        return res.status(400).json({
            success: false,
            error: 'Chat ID ainda n√£o configurado para +5581987740434',
            instructions: [
                '1. Pessoa deve interagir com @lbertoBot',
                '2. Use GET /telegram/users para ver Chat ID',
                '3. Use POST /setup-new-doctor com o Chat ID'
            ]
        });
    }
    
    try {
        const results = await sendDoctorNotification('dr_novo', severity, patientName, '123.456.789-00', '+5581987740434', score);
        
        const confirmationMessages = [];
        if (results.whatsapp) {
            confirmationMessages.push('üì± **Notifica√ß√£o enviada ao +5581987740434 via WhatsApp com sucesso!**');
        }
        if (results.telegram) {
            confirmationMessages.push('üì± **Notifica√ß√£o enviada ao +5581987740434 via Telegram com sucesso!**');
        }
        
        res.json({
            success: true,
            message: 'Teste enviado para +5581987740434!',
            confirmations: confirmationMessages,
            results: results
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Middleware para capturar erros 404
app.use('*', (req, res) => {
    res.status(404).json({
        error: 'Rota n√£o encontrada',
        availableRoutes: [
            'GET /',
            'GET /status',
            'GET /doctors',
            'GET /telegram/users',
            'POST /send-whatsapp',
            'POST /test-telegram',
            'POST /notify-doctor',
            'POST /notify-multiple-doctors',
            'POST /telegram/test-chat',
            'POST /setup-new-doctor',
            'POST /test-new-doctor'
        ]
    });
});

// Middleware para tratamento de erros
app.use((error, req, res, next) => {
    console.error('‚ùå Erro interno:', error);
    res.status(500).json({
        success: false,
        error: 'Erro interno do servidor',
        message: error.message
    });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`üöÄ Servidor rodando na porta ${PORT}`);
    console.log(`üåê Acesse: http://localhost:${PORT}`);
    console.log(`üìä Status: http://localhost:${PORT}/status`);
    console.log(`üë• M√©dicos: http://localhost:${PORT}/doctors`);
    console.log(`üì± Teste Telegram: POST http://localhost:${PORT}/test-telegram`);
    console.log('=====================================');
});
